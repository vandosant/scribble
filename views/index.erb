<div class="container">
  <div class="title">Scribble</div>

  <div class="label" id="volume-label">Volume</div>
  <input type="range" min="0" max="100" class="volume" value="100">
</div>
<div class="keyboard">
  <div class="key" id="key-A"></div>
  <div class="black-key" id="key-W"></div>
  <div class="key" id="key-S"></div>
  <div class="black-key" id="key-E"></div>
  <div class="key" id="key-D"></div>
  <div class="key" id="key-F"></div>
  <div class="black-key" id="key-T"></div>
  <div class="key" id="key-G"></div>
  <div class="black-key" id="key-Y"></div>
  <div class="key" id="key-H"></div>
  <div class="black-key" id="key-U"></div>
  <div class="key" id="key-J"></div>
  <div class="key" id="key-K"></div>
</div>

<div class="drum-machine">
  <div class="drum-button" id="drum-0">1</div>
  <div class="drum-button" id="drum-1">2</div>
  <div class="drum-button" id="drum-2">3</div>
  <div class="drum-button" id="drum-3">4</div>
  <div class="drum-button" id="drum-4">5</div>
  <div class="drum-button" id="drum-5">6</div>
  <div class="drum-button" id="drum-6">7</div>
  <div class="drum-button" id="drum-7">8</div>
</div>
<div class="drum-machine">
  <div class="drum-button" id="drum-8">9</div>
  <div class="drum-button" id="drum-9">10</div>
  <div class="drum-button" id="drum-10">11</div>
  <div class="drum-button" id="drum-11">12</div>
  <div class="drum-button" id="drum-12">13</div>
  <div class="drum-button" id="drum-13">14</div>
  <div class="drum-button" id="drum-14">15</div>
  <div class="drum-button" id="drum-15">16</div>
</div>
<div class="drum-machine">
  <div class="drum-button bass-drum">Bass</div>
  <div class="drum-button snare-drum">Snare</div>
</div>
<script>
  var contextClass = (window.AudioContext ||
    window.webkitAudioContext ||
    window.mozAudioContext ||
    window.oAudioContext ||
    window.msAudioContext);
  if (contextClass) {
    var context = new contextClass();
  } else {
    $(document).append('<div class="errors">Sorry, your browser is not supported.</div>');
  }

  var initialFrequency = 261.63;
  var initialVolume = 0;
  var currentVolume = 0.25;
  var $key = $(".key");
  var keysDown = [];
  var oscillators = [];
  var drumMachine = new DrumMachine(context);


  var int = function () {
    for (var i = 0; i < 13; i++) {
      var osc = new Oscillator(context, initialFrequency, initialVolume);
      oscillators.push(osc);
    }
  };

  int();

  oscillators.forEach(function (osc) {
    osc.connect();
  });
  var keys = {
    'A': {
      key: 65,
      index: 0,
      freq: 261.63
    },
    'W': {
      key: 87,
      index: 1,
      freq: 277.18
    },
    'S': {
      key: 83,
      index: 2,
      freq: 293.66
    },
    'E': {
      key: 69,
      index: 3,
      freq: 311.13
    },
    'D': {
      key: 68,
      index: 4,
      freq: 329.63
    },
    'F': {
      key: 70,
      index: 5,
      freq: 349.23
    },
    'T': {
      key: 84,
      index: 6,
      freq: 369.99
    },
    'G': {
      key: 71,
      index: 7,
      freq: 392.00
    },
    'Y': {
      key: 89,
      index: 8,
      freq: 415.30
    },
    'H': {
      key: 72,
      index: 9,
      freq: 440.00
    },
    'U': {
      key: 85,
      index: 10,
      freq: 466.16
    },
    'J': {
      key: 74,
      index: 11,
      freq: 493.88
    },
    'K': {
      key: 75,
      index: 12,
      freq: 523.25
    }
  };

  $('.volume').change(function () {
    currentVolume = (this.value / 100) * 0.25;
  });

  $(document).keydown(function (e) {
    if (keysDown.indexOf(e.which) === -1) {
      var char = String.fromCharCode(e.which);
      var key = keys[char];
      if (key) {
        oscillators[key.index].updateNote(key.freq);
        oscillators[key.index].updateVolume(currentVolume);
        keysDown.push(e.which);
        $("#key-" + char).addClass("keyon");
      }
    }
  });

  $(document).keyup(function (e) {
    var char = String.fromCharCode(e.which);
    var key = keys[char];
    if (key) {
      oscillators[key.index].updateVolume(0);
      $("#key-" + char).removeClass("keyon");
      keysDown.pop(e.which);
    }
  });

  var node = 0;
  setInterval(function () {
    $('.drum-button').removeClass('drum-button-active');
    $('#drum-' + node).addClass('drum-button-active');

    if ($('#drum-' + node).hasClass('drum-button-selected')) {
      if ($(".bass-drum").hasClass('drum-button-selected')) {
        drumMachine.bassKick();
      } else if ($(".snare-drum").hasClass('drum-button-selected')) {
        drumMachine.snareHit();
      }
    }

    if (node === 15) {
      node = 0;
    } else {
      node++;
    }
  }, 250);

  $('.drum-button').click(function () {
    $(this).toggleClass('drum-button-selected');
  });

  $('.bass-drum').click(function () {
    $('.bass-drum').removeClass('drum-button-selected');
    $('.snare-drum').removeClass('drum-button-selected');
    $(this).addClass('drum-button-selected');
  });

  $('.snare-drum').click(function () {
    $('.bass-drum').removeClass('drum-button-selected');
    $('.snare-drum').removeClass('drum-button-selected');
    $(this).addClass('drum-button-selected');
  });
</script>